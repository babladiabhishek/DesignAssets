name: ðŸŽ¨ Production Icon Sync

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 9 * * 1'  # Run every Monday at 9 AM UTC
  push:
    branches: [ main ]

jobs:
  fetch-icons:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests fuzzywuzzy python-levenshtein
        
    - name: Fetch icons from Figma
      env:
        FIGMA_FILE_ID: ${{ secrets.FIGMA_FILE_ID }}
        FIGMA_PERSONAL_TOKEN: ${{ secrets.FIGMA_PERSONAL_TOKEN }}
      run: |
        echo "ðŸš€ Starting automated icon fetch from production Figma..."
        python3 fetch_icons_advanced.py
        
    - name: Set up Swift
      uses: swift-actions/setup-swift@v1
      with:
        swift-version: "5.9"
        
    - name: Generate Swift code from assets
      run: |
        echo "ðŸ”§ Generating Swift code from downloaded assets..."
        swift package plugin generate-enums
        
    - name: Check for changes
      id: changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Changes detected in assets or generated code"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "âœ… No changes detected"
        fi
        
    - name: Commit and push changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Sources/DesignAssets/Resources/
        git add Sources/DesignAssets/GeneratedIcons.swift
        git commit -m "ðŸ¤– Auto-update icons from production Figma

        - Fetched latest icons using advanced categorization
        - Updated asset catalogs and generated Swift code
        - Generated by GitHub Actions workflow
        
        Categories updated:
        - Flags: $(find Sources/DesignAssets/Resources/Flags.xcassets -name "*.imageset" | wc -l) icons
        - Icons: $(find Sources/DesignAssets/Resources/Icons.xcassets -name "*.imageset" | wc -l) icons  
        - Images: $(find Sources/DesignAssets/Resources/Images.xcassets -name "*.imageset" | wc -l) icons
        - Logos: $(find Sources/DesignAssets/Resources/Logos.xcassets -name "*.imageset" | wc -l) icons
        - Map: $(find Sources/DesignAssets/Resources/Map.xcassets -name "*.imageset" | wc -l) icons
        - Illustrations: $(find Sources/DesignAssets/Resources/Illustrations.xcassets -name "*.imageset" | wc -l) icons"
        git push
        
    - name: Create summary
      run: |
        echo "## ðŸŽ‰ Icon Fetch Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Results:" >> $GITHUB_STEP_SUMMARY
        echo "- **Flags**: $(find Sources/DesignAssets/Resources/Flags.xcassets -name "*.imageset" 2>/dev/null | wc -l) icons" >> $GITHUB_STEP_SUMMARY
        echo "- **Icons**: $(find Sources/DesignAssets/Resources/Icons.xcassets -name "*.imageset" 2>/dev/null | wc -l) icons" >> $GITHUB_STEP_SUMMARY
        echo "- **Images**: $(find Sources/DesignAssets/Resources/Images.xcassets -name "*.imageset" 2>/dev/null | wc -l) icons" >> $GITHUB_STEP_SUMMARY
        echo "- **Logos**: $(find Sources/DesignAssets/Resources/Logos.xcassets -name "*.imageset" 2>/dev/null | wc -l) icons" >> $GITHUB_STEP_SUMMARY
        echo "- **Map**: $(find Sources/DesignAssets/Resources/Map.xcassets -name "*.imageset" 2>/dev/null | wc -l) icons" >> $GITHUB_STEP_SUMMARY
        echo "- **Illustrations**: $(find Sources/DesignAssets/Resources/Illustrations.xcassets -name "*.imageset" 2>/dev/null | wc -l) icons" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Status:" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.changes.outputs.changes }}" == "true" ]; then
          echo "âœ… Changes detected and committed to repository" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No changes detected - assets are up to date" >> $GITHUB_STEP_SUMMARY
        fi
