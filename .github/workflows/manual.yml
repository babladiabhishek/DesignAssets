name: ðŸ”§ Manual Icon Fetch

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh all icons (ignore cache)'
        required: false
        default: false
        type: boolean

jobs:
  fetch-icons:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests fuzzywuzzy python-levenshtein
        
    - name: Fetch icons from Figma
      env:
        FIGMA_FILE_ID: ${{ secrets.FIGMA_FILE_ID }}
        FIGMA_PERSONAL_TOKEN: ${{ secrets.FIGMA_PERSONAL_TOKEN }}
        FORCE_DOWNLOAD: ${{ github.event.inputs.force_refresh }}
      run: |
        echo "ðŸš€ Manual icon fetch triggered"
        if [ "${{ github.event.inputs.force_refresh }}" == "true" ]; then
          echo "ðŸ”„ Force refresh enabled - will re-download all icons"
        fi
        python3 fetch_icons_advanced.py
        
    - name: Set up Swift
      uses: swift-actions/setup-swift@v1
      with:
        swift-version: "5.9"
        
    - name: Generate Swift code
      run: |
        echo "ðŸ”§ Generating Swift code..."
        swift package plugin generate-enums
        
    - name: Show results
      run: |
        echo "## ðŸ“Š Manual Fetch Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Asset Counts:" >> $GITHUB_STEP_SUMMARY
        for category in Flags Icons Images Logos Map Illustrations; do
          count=$(find Sources/DesignAssets/Resources/${category}.xcassets -name "*.imageset" 2>/dev/null | wc -l)
          echo "- **${category}**: ${count} icons" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Updated:" >> $GITHUB_STEP_SUMMARY
        echo "- Asset catalogs in \`Sources/DesignAssets/Resources/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Generated Swift code: \`Sources/DesignAssets/GeneratedIcons.swift\`" >> $GITHUB_STEP_SUMMARY
